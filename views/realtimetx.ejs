<%- include("partials/header.ejs") %>
<div class="main">
    <h1>Hello world</h1>
    <div id="map"></div>
</div>
<script src="/socket.io.js"></script>
<script>
    const socket = io();

    let packet = {
        room: "<%= room %>"
    }

    socket.emit("join_room", packet.room)

    if (navigator.geolocation) {
    const options = {timeout:60000};
    setInterval(function() {
        navigator.geolocation.getCurrentPosition(success, error, options);
    }, 2000)
  } else {
    alert("Geolocation is not supported by this browser");
  }

  function success(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    let packet = {
        latitude: latitude,
        longitude: longitude,
    }
    console.log("Sending " + latitude + longitude)
    socket.emit("location", packet)
    getMap(latitude, longitude);
  }
  function error() {
    alert("Unable to retrieve location");
  }

  function getMap(latitude, longitude) {

    clearMap();

    let customIcon = {
      iconUrl:"/dogface.png",
      iconSize:[20,20]
    }

    let myIcon = L.icon(customIcon);

    let iconOptions = {
      title:"company name",
      draggable:true,
      icon:myIcon
    }

    const map = L.map("map").setView([latitude, longitude], 50);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
      map
    );
    L.marker([latitude, longitude], iconOptions).addTo(map);
  }

  function clearMap() {
    console.log("Running clearmap")
    const map = L.map("map")
    map.off();
    map.remove();
  }

</script>
<%- include("partials/footer.ejs") %>